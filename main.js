(()=>{"use strict";const t=new class{generate(t){if(!1===t||null==t)return document.createTextNode("");if("string"!=typeof t.type)return document.createTextNode("");const e=document.createElement(`${t.type}`);return t.attr&&Object.entries(t.attr).forEach((([t,n])=>{"class"===t?e.className=n.join(" "):e.setAttribute(t,n)})),t.listener&&(Array.isArray(t.listener)?t.listener.forEach((t=>e.addEventListener(t.type,t.cb))):e.addEventListener(t.listener.type,t.listener.cb)),"string"==typeof t.content?(""===t.content&&(e.textContent=""),e.textContent=t.content):Array.isArray(t.content)?t.content.forEach((t=>e.appendChild(this.generate(t)))):"object"==typeof t.content&&e.appendChild(this.generate(t.content)),e}};const e=new class{constructor(){this.handlers=[]}subscribe(t,e,n){void 0===n&&(n=e),this.handlers.push({event:t,handler:e.bind(n)})}emit(t,...e){1===e.length&&(e=e[0]),this.handlers.forEach((n=>{n.event===t&&n.handler(e)}))}};class n{constructor(t){if(!(t instanceof HTMLElement))throw new Error("Передайте HTML элемент");this.container=t}render(){return t.generate({type:"div",attr:{class:["modal__form"]},content:[{type:"div",attr:{class:["modal__background"]},content:""},{type:"div",attr:{class:["modal__content"]},content:[{type:"div",attr:{class:["modal__header"]},content:""},{type:"div",attr:{class:["modal__body"]},content:{type:"form",attr:{class:["modal__form"],name:"modal-form"},listener:{type:"submit",cb:t=>this.submit(t)},content:[{type:"div",attr:{class:["form__group"]},content:[{type:"label",attr:{class:["form__label"],for:"username-field"},content:"Username"},{type:"input",attr:{class:["form__input"],id:"username-field",name:"name",placeholder:"Please enter your name..."},content:""},{type:"div",attr:{class:["form__hint","hidden"]},content:""}]}]}},{type:"div",attr:{class:["modal__footer"]},content:[{type:"div",attr:{class:["modal__close"]},listener:{type:"click",cb:t=>this.close(t)},content:"Close"},{type:"div",attr:{class:["modal__ok"]},listener:{type:"click",cb:t=>this.submit(t)},content:"Ok"}]}]}]})}bindToDOM(){this.container.appendChild(this.render()),this.modalElement=this.container.querySelector(".modal__form"),this.formElement=this.modalElement.querySelector("form")}submit(t){t.preventDefault();const{formElement:n}=this;if(""===n.elements.name.value)return;const s={name:n.elements.name.value};this.modalElement.querySelector(".modal__header").textContent="",e.emit("connect-chat",s)}close(){this.clearForm(),this.modalElement.classList.remove("active")}showModal(){this.hideHint(),this.modalElement.classList.add("active")}showHint(t){const e=this.formElement.querySelector(".form__hint");e.textContent=t,e.classList.remove("hidden")}hideHint(){const t=this.formElement.querySelector(".form__hint");t.textContent="",t.classList.add("hidden")}clearForm(){const{formElement:t}=this;t.elements.name.value=""}}const s=async t=>{const e=`https://astro-messenger.herokuapp.com${t.query}`,n=await fetch(e,{method:t.method,body:t.data?JSON.stringify(t.data):null}),s=await n.json();return t.callback&&t.callback(s),s};class a extends class{list(){}get(){}create(){}update(){}delete(){}}{create(t,e){return s({method:"POST",query:"/newuser",data:t,callback:e})}}const r=document.getElementById("root");new class{constructor(t){this.container=t,this.api=new a,this.websocket=null}init(){this.bindToDOM(),this.registerEvents(),this.modalWithForm=new n(this.container),this.modalWithForm.bindToDOM(),this.subscribeOnEvents()}bindToDOM(){const e=t.generate({type:"div",attr:{class:["container"]},content:[{type:"div",attr:{class:["chat__header"]},content:{type:"h1",attr:{class:["chat__title"]},content:"AstroMessenger"}},{type:"div",attr:{class:["chat__connect"]},content:"Chat connect"},{type:"div",attr:{class:["chat__container"]},content:[{type:"div",attr:{class:["chat__area"]},content:[{type:"div",attr:{class:["chat__messages-container"]},content:""},{type:"div",attr:{class:["chat__messages-input"]},content:{type:"div",attr:{class:["form__group"]},content:{type:"input",attr:{class:["form__input"],type:"text",id:"message-field",name:"message",placeholder:"Please enter your message...",disabled:!0},content:""}}}]},{type:"div",attr:{class:["chat__userlist"]},content:""}]}]});this.container.appendChild(e),this.userListContainer=this.container.querySelector(".chat__userlist"),this.inputElement=this.container.querySelector(".form__input"),this.connectButton=this.container.querySelector(".chat__connect"),this.messageContainer=this.container.querySelector(".chat__messages-container")}registerEvents(){this.connectButton.addEventListener("click",(()=>this.modalWithForm.showModal())),this.inputElement.addEventListener("keydown",(t=>{13===t.keyCode&&this.sendMessage()}))}subscribeOnEvents(){e.subscribe("connect-chat",this.onEnterChatHandler,this)}async onEnterChatHandler(t){const e=await this.api.create(t);"ok"===e.status?(this.modalWithForm.hideHint(),this.modalWithForm.close(),this.connectButton.classList.add("hidden"),this.user=e.user,this.inputElement.disabled=!1,this.websocket=new WebSocket("wss://astro-messenger.herokuapp.com/chat"),this.websocket.addEventListener("message",(t=>this.renderMessage(t))),window.addEventListener("beforeunload",(()=>this.websocket.send(JSON.stringify({type:"exit",user:this.user}))))):this.modalWithForm.showHint(e.message)}sendMessage(){const{value:t}=this.inputElement;this.websocket.send(JSON.stringify({type:"send",message:t,user:this.user})),this.inputElement.value=""}renderMessage(e){const n=JSON.parse(e.data);if(Array.isArray(n))return this.userListContainer.textContent="",void n.forEach((e=>{const n=t.generate({type:"div",attr:{class:["chat__user"],"data-user-id":e.id},content:e.name===this.user.name?"You":e.name});this.userListContainer.appendChild(n)}));const s=new Date,a=`${s.toLocaleTimeString().slice(0,5)} ${s.toLocaleDateString()} `,r=t.generate({type:"div",attr:{class:["message__container",""+(n.user.name===this.user.name?"message__container-yourself":"message__container-interlocutor")]},content:[{type:"div",attr:{class:["message__header"]},content:`${n.user.name===this.user.name?"You":n.user.name}, ${a}`},{type:"div",attr:{class:["message__body"]},content:n.message}]});this.messageContainer.appendChild(r),this.messageContainer.lastElementChild.scrollIntoView()}}(r).init()})();